<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>AI Face Attendance</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; text-align: center; padding: 20px; }
        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 1400px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); flex: 1; min-width: 350px; }
        img.video-feed { width: 100%; border-radius: 8px; border: 3px solid #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; } tr:first-child { background: #e8f5e9; }
        .evidence-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
        .btn { padding: 10px; border: none; border-radius: 5px; cursor: pointer; color: white; margin: 5px; }
        .btn-blue { background: #007bff; } .btn-green { background: #28a745; text-decoration: none; display: inline-block; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .admin-link { position: absolute; top: 20px; right: 20px; text-decoration: none; font-size: 24px; }
    </style>
</head>
<body>
    <a href="/admin" class="admin-link">‚öôÔ∏è Admin</a>
    <h1>üì∏ ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</h1>

    <div class="container">
        <div class="card">
            <h3>üî¥ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö</h3>
            <img src="/video_feed" class="video-feed" id="videoElement">
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                <h4>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h4>
                <input type="text" id="empName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                <button class="btn btn-blue" onclick="takeSnapshot()">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                <br>
                <a href="/export_excel" class="btn btn-green">üìä ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel</a>
            </div>
        </div>

        <div class="card">
            <h3>üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            <table>
                <thead><tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
    
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>

    <script>
        async function takeSnapshot() {
            const name = document.getElementById('empName').value;
            if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");
            const cvs = document.getElementById('canvas');
            cvs.getContext('2d').drawImage(document.getElementById('videoElement'), 0, 0, cvs.width, cvs.height);
            cvs.toBlob(async (blob) => {
                const fd = new FormData(); fd.append('name', name); fd.append('file', blob, `${name}.jpg`);
                try {
                    const res = await fetch('/register_snapshot', { method: 'POST', body: fd });
                    const j = await res.json(); alert(j.message);
                    if(j.status==='success') document.getElementById('empName').value='';
                } catch(e) { alert("Error"); }
            }, 'image/jpeg');
        }

        async function updateTable() {
            try {
                const res = await fetch('/recent_attendance');
                const j = await res.json();
                const tb = document.getElementById('tableBody'); tb.innerHTML = '';
                j.data.forEach(r => {
                    const img = r.evidence_image ? `/${r.evidence_image}` : 'https://via.placeholder.com/50';
                    tb.innerHTML += `<tr><td><img src="${img}" class="evidence-img"></td><td><strong>${r.employee_name}</strong></td><td>${r.check_time}</td></tr>`;
                });
                if (j.new_entry && j.voice_enabled && 'speechSynthesis' in window) {
                    const msg = new SpeechSynthesisUtterance("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ‡∏Ñ‡∏∏‡∏ì " + j.latest_name);
                    msg.lang = 'th-TH'; window.speechSynthesis.speak(msg);
                }
            } catch(e) {}
        }
        setInterval(updateTable, 2000); updateTable();
    </script>
</body>
</html>