<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Face Attendance - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee; --success: #4cc9f0; --warning: #f72585; --bg: #f8f9fa;
        }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { font-size: 28px; margin: 0; color: var(--primary); }

        /* Summary Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); }
        .stat-card h3 { margin: 0; color: #888; font-size: 14px; text-transform: uppercase; }
        .stat-card .value { font-size: 36px; font-weight: bold; margin: 10px 0; display: block; }

        /* Charts & Server Status */
        .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .box h2 { font-size: 18px; margin-bottom: 20px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        /* Progress Bars for Server */
        .progress-group { margin-bottom: 20px; }
        .progress-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: 600; }
        .progress-bg { background: #eee; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.5s; }

        /* Attendance Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; padding: 12px; color: #888; font-size: 14px; background: #fdfdfd; }
        td { padding: 12px; border-bottom: 1px solid #f1f1f1; font-size: 15px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .badge-normal { background: #e0f9f1; color: #1fb384; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</h1>
            <span id="live-clock" style="font-weight: bold; color: #777;"></span>
        </div>

        <div class="stats-grid">
            <div class="stat-card" style="border-left-color: #4361ee;">
                <h3>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <span class="value" id="total_emp">0</span>
            </div>
            <div class="stat-card" style="border-left-color: #2ecc71;">
                <h3>‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                <span class="value" id="present_today">0</span>
            </div>
            <div class="stat-card" style="border-left-color: #f72585;">
                <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤</h3>
                <span class="value" id="absent_today">0</span>
            </div>
        </div>

        <div class="content-grid">
            <div class="box">
                <h2>üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
                <canvas id="weeklyChart" height="150"></canvas>
            </div>

            <div class="box">
                <h2>üñ•Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</h2>
                <div class="progress-group">
                    <div class="progress-label"><span>CPU Usage</span><span id="cpu-text">0%</span></div>
                    <div class="progress-bg"><div id="cpu-bar" class="progress-fill" style="width: 0%"></div></div>
                </div>
                <div class="progress-group">
                    <div class="progress-label"><span>RAM Usage</span><span id="ram-text">0%</span></div>
                    <div class="progress-bg"><div id="ram-bar" class="progress-fill" style="width: 0%; background: #4cc9f0;"></div></div>
                </div>
                <p style="font-size: 13px; color: #aaa;">Status: AI Core Running (Facenet512)</p>
            </div>
        </div>
    </div>
    <div class="box mt-4">
    <h2>üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Today's Duty)</h2>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                    <th>‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                    <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</th>
                </tr>
            </thead>
            <tbody id="shiftTableBody">
               
            </tbody>
        </table>
    </div>
</div>

    <script>
        // üïí ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡πÅ‡∏ö‡∏ö Real-time
        function updateClock() {
            document.getElementById('live-clock').innerText = new Date().toLocaleString('th-TH');
        }
        setInterval(updateClock, 1000);

        // üìä ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
        async function fetchStats() {
            try {
                const res = await fetch('/api/daily_stats');
                const d = await res.json();
                document.getElementById('total_emp').innerText = d.total;
                document.getElementById('present_today').innerText = d.present;
                document.getElementById('absent_today').innerText = d.absent;
            } catch (e) { console.error("API Error", e); }
        }

        // üñ•Ô∏è ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Server Status
        // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÉ‡∏ô main.py ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏î‡πâ
        async function updateServerInfo() {
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ CPU/RAM ‡∏à‡∏≤‡∏Å API ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô main.py (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
            const cpu = Math.floor(Math.random() * 20) + 10;
            document.getElementById('cpu-text').innerText = cpu + '%';
            document.getElementById('cpu-bar').style.width = cpu + '%';
        }

        // üìà ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
        function initChart() {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå', '‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'],
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏ô‡πâ‡∏≤',
                        data: [12, 19, 15, 17, 14, 5, 2],
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { plugins: { legend: { display: false } } }
            });
        }
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
async function loadCurrentShifts() {
    const res = await fetch('/api/current_shifts');
    const data = await res.json();
    const tbody = document.getElementById('shiftTableBody');
    tbody.innerHTML = '';

    data.forEach(item => {
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        let statusBadge = '<span class="badge bg-light text-dark">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πÅ‡∏Å‡∏ô</span>';
        if(item.current_status === 'Normal') statusBadge = '<span class="badge bg-success">‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>';
        if(item.current_status === 'Late') statusBadge = '<span class="badge bg-warning text-dark">‡∏°‡∏≤‡∏™‡∏≤‡∏¢</span>';

        tbody.innerHTML += `
            <tr>
                <td>${item.employee_id}</td>
                <td><strong>${item.name}</strong></td>
                <td><span class="badge bg-info text-dark">${item.role_name}</span></td>
                <td>${item.start_time} - ${item.end_time}</td>
                <td>${statusBadge}</td>
            </tr>`;
    });
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
loadCurrentShifts();
setInterval(loadCurrentShifts, 30000); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

        fetchStats();
        setInterval(fetchStats, 10000); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(updateServerInfo, 3000);
        initChart();
    </script>
</body>
</html>