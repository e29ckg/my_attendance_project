<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard & Server Status</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 24px; color: #2c3e50; }
        .back-btn { text-decoration: none; background: #fff; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #555; font-weight: bold; transition: 0.2s; }
        .back-btn:hover { background: #e9ecef; }

        /* Server Status Cards */
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .status-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; overflow: hidden; }
        .status-card h3 { margin: 0 0 10px; font-size: 16px; color: #7f8c8d; }
        .status-value { font-size: 32px; font-weight: bold; color: #2c3e50; }
        .status-sub { font-size: 14px; color: #95a5a6; }
        
        /* Progress Bar */
        .progress-bg { height: 8px; background: #eee; border-radius: 4px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; border-radius: 4px; transition: width 0.5s ease-in-out; }
        
        .cpu-fill { background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); }
        .ram-fill { background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%); }
        .disk-fill { background: linear-gradient(90deg, #fa709a 0%, #fee140 100%); }

        /* Sections */
        .section { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .section h2 { border-bottom: 2px solid #f0f2f5; padding-bottom: 15px; margin-top: 0; font-size: 20px; }
        
        /* Form Elements */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        input[type="text"], input[type="number"], input[type="password"], input[type="time"] {
            width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; font-family: inherit;
        }
        
        /* Checkbox Group */
        .checkbox-wrapper { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
        .cb-item { background: #f8f9fa; padding: 10px 15px; border-radius: 8px; border: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .cb-item:hover { background: #e9ecef; }
        input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }

        /* Buttons */
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .btn-save { background: #3b82f6; color: white; width: 100%; margin-top: 20px; }
        .btn-save:hover { background: #2563eb; }
        .btn-refresh { background: #64748b; color: white; padding: 8px 15px; font-size: 14px; }
        .btn-del { background: #ef4444; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; background: #f1f5f9; padding: 12px; font-size: 14px; border-radius: 6px; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        img.avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è Admin Panel</h1>
            <a href="/" class="back-btn">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <h3>‚ö° CPU Usage</h3>
                <div class="status-value" id="cpuVal">0%</div>
                <div class="progress-bg"><div class="progress-fill cpu-fill" id="cpuBar"></div></div>
            </div>
            <div class="status-card">
                <h3>üß† RAM Usage</h3>
                <div class="status-value" id="ramVal">0%</div>
                <div class="status-sub">Free: <span id="ramFree">0</span> GB</div>
                <div class="progress-bg"><div class="progress-fill ram-fill" id="ramBar"></div></div>
            </div>
            <div class="status-card">
                <h3>üíæ Disk Space</h3>
                <div class="status-value" id="diskVal">0%</div>
                <div class="status-sub">Free: <span id="diskFree">0</span> GB</div>
                <div class="progress-bg"><div class="progress-fill disk-fill" id="diskBar"></div></div>
            </div>
        </div>

        <div class="section">
            <h2>üõ†Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (System Settings)</h2>
            <div class="form-grid">
                <div>
                    <div class="form-group"><label>‚è±Ô∏è Cooldown (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label><input type="number" id="cooldown"></div>
                    <div class="form-group"><label>üéØ Threshold (0.1-0.9)</label><input type="number" step="0.01" id="threshold"></div>
                    <div class="form-group"><label>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≤‡∏¢ (Late Time)</label><input type="time" id="lateTime"></div>
                </div>
                <div>
                    <div class="form-group"><label>üì∑ Camera ID</label><input type="number" id="camIndex"></div>
                    <div class="form-group"><label>üìè Width</label><input type="number" id="camWidth"></div>
                    <div class="form-group"><label>üìê Height</label><input type="number" id="camHeight"></div>
                </div>
            </div>

            <div class="checkbox-wrapper">
                <label class="cb-item"><input type="checkbox" id="voice"> üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î (Voice)</label>
                <label class="cb-item"><input type="checkbox" id="smartCool"> üßä ‡∏Å‡∏±‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥ (Smart Cooldown)</label>
                <label class="cb-item" style="border-color: #f59e0b; background: #fffbeb;">
                    <input type="checkbox" id="liveness"> üëÅÔ∏è Liveness (‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ï‡∏≤)
                </label>
            </div>
        </div>

        <div class="section">
            <h2>üîî ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Notification)</h2>
            <div class="checkbox-wrapper" style="margin-bottom: 15px;">
                <label class="cb-item"><input type="checkbox" id="enableTg"> ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Telegram</label>
            </div>
            <div class="form-grid">
                <div class="form-group"><label>Bot Token</label><input type="text" id="tgToken"></div>
                <div class="form-group"><label>Chat ID</label><input type="text" id="tgChatId"></div>
            </div>
        </div>

        <div class="section">
            <h2>üóÑÔ∏è ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Database)</h2>
            <div class="form-grid">
                <div class="form-group"><label>Host</label><input type="text" id="db_host"></div>
                <div class="form-group"><label>User</label><input type="text" id="db_user"></div>
                <div class="form-group"><label>Password</label><input type="password" id="db_password"></div>
                <div class="form-group"><label>DB Name</label><input type="text" id="db_name"></div>
            </div>
        </div>
        
        <button class="btn btn-save" onclick="saveSettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Save All)</button>
        
        <div class="section" style="margin-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h2>
                <button class="btn btn-refresh" onclick="loadEmps()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
            <table>
                <thead><tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="empTableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- 1. Monitor Script ---
        async function updateServerStatus() {
            try {
                const res = await fetch('/api/server_status');
                const d = await res.json();

                // CPU
                document.getElementById('cpuVal').innerText = d.cpu + '%';
                document.getElementById('cpuBar').style.width = d.cpu + '%';

                // RAM
                document.getElementById('ramVal').innerText = d.ram_percent + '%';
                document.getElementById('ramFree').innerText = (d.ram_total - d.ram_used).toFixed(2);
                document.getElementById('ramBar').style.width = d.ram_percent + '%';

                // Disk
                document.getElementById('diskVal').innerText = d.disk_percent + '%';
                document.getElementById('diskFree').innerText = d.disk_free;
                document.getElementById('diskBar').style.width = d.disk_percent + '%';
            } catch(e) { console.error("Monitor Error:", e); }
        }
        setInterval(updateServerStatus, 2000); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        updateServerStatus();

        // --- 2. Settings Script ---
        async function loadSettings() {
            const res = await fetch('/api/settings');
            const d = await res.json();

            // General
            document.getElementById('cooldown').value = d.cooldown_seconds;
            document.getElementById('threshold').value = d.threshold;
            document.getElementById('lateTime').value = d.late_time;
            document.getElementById('voice').checked = d.enable_voice;
            document.getElementById('smartCool').checked = d.enable_cooldown;
            document.getElementById('liveness').checked = d.enable_liveness ?? true;

            // Camera
            document.getElementById('camIndex').value = d.camera_index || 0;
            document.getElementById('camWidth').value = d.camera_width || 640;
            document.getElementById('camHeight').value = d.camera_height || 480;

            // Telegram
            document.getElementById('enableTg').checked = d.enable_telegram ?? false;
            document.getElementById('tgToken').value = d.telegram_bot_token || "";
            document.getElementById('tgChatId').value = d.telegram_chat_id || "";

            // DB
            document.getElementById('db_host').value = d.db_host || "localhost";
            document.getElementById('db_user').value = d.db_user || "root";
            document.getElementById('db_password').value = d.db_password || "";
            document.getElementById('db_name').value = d.db_name || "attendance_system";
        }

        async function saveSettings() {
            const config = {
                cooldown_seconds: parseInt(document.getElementById('cooldown').value),
                threshold: parseFloat(document.getElementById('threshold').value),
                late_time: document.getElementById('lateTime').value,
                enable_voice: document.getElementById('voice').checked,
                enable_cooldown: document.getElementById('smartCool').checked,
                enable_liveness: document.getElementById('liveness').checked,
                
                enable_telegram: document.getElementById('enableTg').checked,
                telegram_bot_token: document.getElementById('tgToken').value,
                telegram_chat_id: document.getElementById('tgChatId').value,

                camera_index: parseInt(document.getElementById('camIndex').value),
                camera_width: parseInt(document.getElementById('camWidth').value),
                camera_height: parseInt(document.getElementById('camHeight').value),

                db_host: document.getElementById('db_host').value,
                db_user: document.getElementById('db_user').value,
                db_password: document.getElementById('db_password').value,
                db_name: document.getElementById('db_name').value
            };
            await fetch('/api/save_settings', { method:'POST', body: JSON.stringify(config) });
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‚úÖ");
        }

        // --- 3. Employee Script ---
        async function loadEmps() {
            const res = await fetch('/api/employees');
            const data = await res.json();
            const tb = document.getElementById('empTableBody'); tb.innerHTML = '';
            data.forEach(e => {
                const path = e.image_path.replace(/\\/g, "/");
                tb.innerHTML += `
                    <tr>
                        <td><img src="/${path}" class="avatar"></td>
                        <td><strong>${e.name}</strong></td>
                        <td><button class="btn btn-del" onclick="delEmp(${e.id})">‡∏•‡∏ö (Delete)</button></td>
                    </tr>`;
            });
        }
        async function delEmp(id) {
            if(confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ?")) {
                await fetch(`/api/delete_employee/${id}`, { method:'DELETE' });
                loadEmps();
            }
        }

        // Init
        loadSettings();
        loadEmps();
    </script>
</body>
</html>