<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>System Monitor & Health Check</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Sarabun', sans-serif; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-stat { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card-stat:hover { transform: translateY(-3px); }
        .icon-box { font-size: 2.2rem; }
        .progress { height: 12px; border-radius: 6px; background-color: #e9ecef; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top mb-4 shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="/"><i class="bi bi-person-bounding-box"></i> HR Face Scan</a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (‡∏™‡πÅ‡∏Å‡∏ô)</a></li>
                    <li class="nav-item"><a class="nav-link" href="/admin">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</a></li>
                    <li class="nav-item"><a class="nav-link" href="/report">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</a></li>
                    <li class="nav-item"><a class="nav-link" href="/print">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°</a></li>
                    <li class="nav-item"><a class="nav-link fw-bold text-danger" href="/monitor">üîß Monitor</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold text-secondary"><i class="bi bi-activity"></i> Server Health & Performance</h4>
            <div class="text-end">
                <span class="badge bg-light text-dark border me-2" id="serverTime">--:--:--</span>
                <button class="btn btn-outline-primary btn-sm" onclick="loadStatus()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="card card-stat p-3 h-100">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-bold text-secondary">CPU Usage</span>
                        <i class="bi bi-cpu text-primary icon-box"></i>
                    </div>
                    <h3 class="fw-bold" id="cpuVal">0%</h3>
                    <div class="progress mb-2">
                        <div id="cpuBar" class="progress-bar bg-primary" style="width: 0%"></div>
                    </div>
                    <small class="text-muted" id="cpuCore">Core: -</small>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-stat p-3 h-100">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-bold text-secondary">RAM Usage</span>
                        <i class="bi bi-memory text-info icon-box"></i>
                    </div>
                    <h3 class="fw-bold" id="ramVal">0%</h3>
                    <div class="progress mb-2">
                        <div id="ramBar" class="progress-bar bg-info" style="width: 0%"></div>
                    </div>
                    <small class="text-muted" id="ramDetail">Used: - / Total: -</small>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-stat p-3 h-100">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-bold text-secondary">Disk Storage</span>
                        <i class="bi bi-hdd text-warning icon-box"></i>
                    </div>
                    <h3 class="fw-bold" id="diskVal">0%</h3>
                    <div class="progress mb-2">
                        <div id="diskBar" class="progress-bar bg-warning" style="width: 0%"></div>
                    </div>
                    <small class="text-muted" id="diskDetail">Used: - / Total: -</small>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-4">
                <div class="card card-stat p-3 h-100 border-start border-5 border-success">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-1">Database Status</h6>
                            <h5 class="fw-bold mb-0" id="dbStatus">Checking...</h5>
                        </div>
                        <i class="bi bi-database-check fs-1 text-success opacity-50"></i>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between small">
                        <span>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <b id="empCount">-</b></span>
                        <span>Logs: <b id="logCount">-</b></span>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-stat p-3 h-100 border-start border-5 border-primary">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-1">AI Engine (DeepFace)</h6>
                            <h5 class="fw-bold mb-0" id="aiStatus">Checking...</h5>
                        </div>
                        <i class="bi bi-robot fs-1 text-primary opacity-50"></i>
                    </div>
                    <hr>
                    <small class="text-muted">‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô RAM: <b id="faceCount">-</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</small>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-stat p-3 h-100 border-start border-5 border-info">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-1">Telegram Noti</h6>
                            <h5 class="fw-bold mb-0" id="tgStatus">Checking...</h5>
                        </div>
                        <i class="bi bi-telegram fs-1 text-info opacity-50"></i>
                    </div>
                    <hr>
                    <button class="btn btn-sm btn-outline-info w-100" onclick="testTelegram()">
                        <i class="bi bi-send"></i> ‡∏Å‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                    </button>
                </div>
            </div>

            <div class="card mt-4 border-warning shadow-sm">
                <div class="card-header bg-warning text-dark fw-bold">
                    <i class="bi bi-tools"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data Management)
                </div>
                <div class="card-body text-center py-4">
                    <div class="row">
                        <div class="col-md-6 border-end">
                            <h5 class="text-dark fw-bold">‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (45 ‡∏ß‡∏±‡∏ô)</h5>
                            <p class="text-muted">‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤ 45 ‡∏ß‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ Server</p>
                            <button class="btn btn-warning btn-lg fw-bold shadow-sm" onclick="cleanupOldData(45)">
                                <i class="bi bi-calendar-x"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ 45 ‡∏ß‡∏±‡∏ô
                            </button>
                        </div>
                        
                        <div class="col-md-6 mt-4 mt-md-0">
                            <h5 class="text-danger fw-bold">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Reset All)</h5>
                            <p class="text-muted">‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà)</p>
                            <button class="btn btn-outline-danger btn-lg fw-bold shadow-sm" onclick="resetAttendanceData()">
                                <i class="bi bi-trash3-fill"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const API_URL = ""; 

        async function loadStatus() {
            try {
                const res = await axios.get(`${API_URL}/api/system/status`);
                const data = res.data;

                document.getElementById('serverTime').innerText = data.time;

                // 1. Update CPU
                updateBar('cpu', data.cpu.percent);
                document.getElementById('cpuCore').innerText = `${data.cpu.cores} Logical Cores`;

                // 2. Update RAM
                updateBar('ram', data.ram.percent);
                document.getElementById('ramDetail').innerText = `${data.ram.used} / ${data.ram.total} (Free: ${data.ram.free})`;

                // 3. Update Disk
                updateBar('disk', data.storage.percent);
                document.getElementById('diskDetail').innerText = `${data.storage.used} / ${data.storage.total}`;

                // 4. DB Status
                const dbEl = document.getElementById('dbStatus');
                if(data.database.status === "OK") {
                    dbEl.innerHTML = '<span class="text-success">üü¢ Online</span>';
                    document.getElementById('empCount').innerText = data.database.employees;
                    document.getElementById('logCount').innerText = data.database.logs;
                } else {
                    dbEl.innerHTML = '<span class="text-danger">üî¥ Error</span>';
                }

                // 5. AI Status
                document.getElementById('aiStatus').innerText = data.ai_model.status;
                document.getElementById('faceCount').innerText = data.ai_model.faces_loaded;

                // 6. Telegram
                const tgEl = document.getElementById('tgStatus');
                tgEl.innerHTML = data.telegram.enabled ? '<span class="text-success">‚úÖ Enabled</span>' : '<span class="text-muted">‚ö™ Disabled</span>';

            } catch (e) { console.error(e); }
        }

        function updateBar(id, percent) {
            document.getElementById(`${id}Val`).innerText = `${percent}%`;
            const bar = document.getElementById(`${id}Bar`);
            bar.style.width = `${percent}%`;
            
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á
            bar.className = 'progress-bar'; // Reset class
            if(percent < 50) bar.classList.add('bg-success');
            else if(percent < 80) bar.classList.add('bg-warning');
            else bar.classList.add('bg-danger');
        }

        async function testTelegram() {
            try {
                const btn = event.target; 
                btn.disabled = true; btn.innerText = "Sending...";
                const res = await axios.post(`${API_URL}/api/system/test-telegram`);
                if(res.data.status === "success") Swal.fire('Success', '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß', 'success');
                else Swal.fire('Fail', res.data.message, 'error');
                btn.disabled = false; btn.innerHTML = '<i class="bi bi-send"></i> ‡∏Å‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°';
            } catch(e) { Swal.fire('Error', 'Connect Error', 'error'); }
        }

        async function resetAttendanceData() {
            // ‡πÉ‡∏ä‡πâ SweetAlert2 ‡∏ñ‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏•‡∏≠‡∏Å‡∏î
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?',
                text: "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ! (‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏Å‡∏ï‡∏¥)",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏•‡∏¢!',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (result.isConfirmed) {
                try {
                    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    
                    const res = await axios.delete('/api/system/reset-attendance');
                    
                    if(res.data.status === 'success') {
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', res.data.message, 'success');
                        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤ Monitor (‡πÄ‡∏ä‡πà‡∏ô loadSystemStatus) ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏õ‡πá‡∏ô 0
                        setTimeout(() => location.reload(), 1500); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
                    } else {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.data.message, 'error');
                    }
                } catch(e) {
                    Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', 'error');
                }
            }
        }

        async function cleanupOldData(days) {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î?',
                text: `‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏™‡πÅ‡∏Å‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤ ${days} ‡∏ß‡∏±‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#ffc107',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏Ñ‡∏•‡∏µ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (result.isConfirmed) {
                try {
                    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    
                    // ‡∏™‡πà‡∏á Request ‡πÑ‡∏õ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô
                    const res = await axios.delete(`/api/system/cleanup-old?days=${days}`);
                    
                    if(res.data.status === 'success') {
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', res.data.message, 'success').then(() => {
                            location.reload(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                        });
                    } else {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', res.data.message, 'error');
                    }
                } catch(e) {
                    Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ', 'error');
                }
            }
        }

        loadStatus();
        setInterval(loadStatus, 5000); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    </script>
</body>
</html>