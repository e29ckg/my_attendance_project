<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f6f9; }
        .page-header { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .table-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .remark-input { border: none; border-bottom: 1px dashed #ccc; width: 100%; color: #555; }
        .remark-input:focus { outline: none; border-bottom: 1px solid #0d6efd; background: #f0f8ff; }
        th { background-color: #0d6efd !important; color: white; text-align: center; }
        td { vertical-align: middle; }
    </style>
</head>
<body class="p-4">

<div class="container">
    
    <div class="page-header">
        <h3 class="mb-4 text-primary">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
        
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label fw-bold">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                <input type="date" id="selectDate" class="form-control">
            </div>
            
            <div class="col-md-4">
                <label class="form-label fw-bold">üë§ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                <select id="selectRole" class="form-select">
                    <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    </select>
            </div>
            
            <div class="col-md-4">
                <button onclick="loadReport()" class="btn btn-primary w-100">
                    üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                </button>
            </div>
        </div>
    </div>

    <div class="table-card" id="reportSection" style="display:none;">
        <div class="d-flex justify-content-between mb-3">
            <h5 id="tableHeader">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ...</h5>
            <button class="btn btn-outline-success btn-sm" onclick="window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th style="width: 50px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                        <th style="width: 150px;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                        <th style="width: 120px;">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th>
                        <th style="width: 120px;">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</th>
                        <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody">
                    </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // const API_URL = "http://localhost:9876"; // ‚ö†Ô∏è ‡πÅ‡∏Å‡πâ IP ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    const API_URL = "";

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    document.getElementById('selectDate').valueAsDate = new Date();

    // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Role ‡∏°‡∏≤‡πÉ‡∏™‡πà Dropdown
    async function loadRoles() {
        try {
            const res = await axios.get(`${API_URL}/api/roles`);
            const select = document.getElementById('selectRole');
            res.data.forEach(role => {
                const opt = document.createElement("option");
                opt.value = role;
                opt.innerText = role;
                select.appendChild(opt);
            });
        } catch (e) { console.error("Load Role Error", e); }
    }

    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
    async function loadReport() {
        const date = document.getElementById('selectDate').value;
        const role = document.getElementById('selectRole').value;
        const roleText = document.getElementById('selectRole').options[document.getElementById('selectRole').selectedIndex].text;
        
        if (!date) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }

        try {
            // ‡πÅ‡∏™‡∏î‡∏á Loading...
            document.getElementById('reportSection').style.display = 'block';
            document.getElementById('reportTableBody').innerHTML = '<tr><td colspan="6" class="text-center py-4">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>';
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            const thaiDate = new Date(date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('tableHeader').innerHTML = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: <b>${roleText}</b> | ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <b>${thaiDate}</b>`;

            // ‡∏¢‡∏¥‡∏á API
            const res = await axios.get(`${API_URL}/api/report/daily?date=${date}&role=${role}`);
            const data = res.data;
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = "";

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</td></tr>';
                return;
            }

            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            data.forEach((item, index) => {
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏µ‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏ó‡∏≤)
                const inClass = item.time_in === "-" ? "text-muted" : "text-success fw-bold";
                const outClass = item.time_out === "-" ? "text-muted" : "text-danger fw-bold";

                const row = `
                <tr>
                    <td class="text-center">${index + 1}</td>
                    <td>${item.name} <br><small class="text-muted">${item.employee_id}</small></td>
                    <td class="text-center"><span class="badge bg-info text-dark">${item.role}</span></td>
                    <td class="text-center ${inClass}">${item.time_in}</td>
                    <td class="text-center ${outClass}">${item.time_out}</td>
                    <td>
                        <input type="text" 
                               class="remark-input" 
                               value="${item.remark}" 
                               placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."
                               onblur="saveRemark('${date}', '${item.employee_id}', this.value)">
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });

        } catch (e) {
            console.error(e);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        }
    }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô)
    async function saveRemark(date, empId, text) {
        try {
            const formData = new FormData();
            formData.append('date', date);
            formData.append('employee_id', empId);
            formData.append('remark', text);

            const res = await axios.post(`${API_URL}/api/report/remark`, formData);
            
            // [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Server ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ß‡πà‡∏≤ success ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°
            if (res.data.status !== "success") {
                alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + res.data.message);
            } else {
                console.log("Saved remark for " + empId);
            }
        } catch (e) {
            console.error(e);
            alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
        }
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    loadRoles();
    loadReport(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î
</script>

</body>
</html>