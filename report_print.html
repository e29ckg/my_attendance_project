<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ - Time Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f6f9; color: #000; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* A4 Page Style */
        .a4-page {
            width: 210mm; min-height: 297mm; background: white;
            padding: 20mm; margin: 20px auto;
            box-shadow: 0 0 15px rgba(0,0,0,0.1); position: relative;
        }
        .table-official { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .table-official th, .table-official td { border: 1px solid black; padding: 6px 8px; vertical-align: middle; font-size: 14px; }
        .table-official th { text-align: center; font-weight: bold; background-color: #f8f9fa; }
        .header-text { text-align: center; font-weight: bold; line-height: 1.5; margin-bottom: 20px; font-size: 16px; }
        .footer-section { margin-top: 40px; font-size: 14px; }
        .dot-line { border-bottom: 1px dotted #000; display: inline-block; min-width: 150px; text-align: center; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .small-dep { font-size: 12px; color: #555; display: block; margin-top: 2px; }

        @media print {
            body { background: white; margin: 0; }
            .no-print { display: none !important; }
            .a4-page { box-shadow: none; margin: 0; width: 100%; padding: 10mm; }
            -webkit-print-color-adjust: exact; 
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top mb-4 no-print">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="/"><i class="bi bi-person-bounding-box"></i> HR Face Scan</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></li>
                    <li class="nav-item"><a class="nav-link" href="/admin">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</a></li>
                    <li class="nav-item"><a class="nav-link" href="/report">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</a></li>
                    <li class="nav-item"><a class="nav-link active fw-bold" href="/print">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°</a></li>
                    <li class="nav-item"><a class="nav-link active fw-bold text-danger" href="/monitor">üîß Monitor</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mb-4 no-print">
        <div class="card p-3 shadow-sm">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="fw-bold">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" id="selectDate" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="fw-bold">üë§ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Role):</label>
                    <select id="selectRole" class="form-select"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
                </div>
                <div class="col-md-2">
                    <label class="fw-bold">‚è∞ ‡∏™‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á:</label>
                    <input type="time" id="lateTime" class="form-control" value="08:30">
                </div>
                <div class="col-md-4 text-end">
                    <button onclick="loadReport()" class="btn btn-primary me-2"><i class="bi bi-search"></i> ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
                    <button onclick="window.print()" class="btn btn-success"><i class="bi bi-printer"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                </div>
            </div>
            <div class="mt-2 text-muted small">
                * ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå
            </div>
        </div>
    </div>

    <div class="a4-page">
        <div class="header-text">
            ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô<br>
            <span id="reportTitle" contenteditable="true">‡∏á‡∏≤‡∏ô‡∏à‡πâ‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°</span><br>
            <span contenteditable="true">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏®‡∏≤‡∏•‡πÄ‡∏¢‡∏≤‡∏ß‡∏ä‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡∏û.‡∏®. 2569</span><br>
            <span id="dateHeader">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ...</span>
        </div>

        <table class="table-official">
            <thead>
                <tr>
                    <th rowspan="2" width="50">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th> <th rowspan="2">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• / ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                    <th colspan="2">‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤</th> <th colspan="2">‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö</th> <th rowspan="2" width="150">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr>
                <tr>
                    <th width="80">‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠</th> <th width="80">‡πÄ‡∏ß‡∏•‡∏≤</th>
                    <th width="80">‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠</th> <th width="80">‡πÄ‡∏ß‡∏•‡∏≤</th>
                </tr>
            </thead>
            <tbody id="reportTableBody"></tbody>
        </table>

        <div class="footer-section">
            <div class="row">
                <div class="col-6">
                    <p>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£</p> <p class="ps-3">- ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡∏î‡∏ó‡∏£‡∏≤‡∏ö</p> <br><br>
                    <div class="text-center w-75"><span>- ‡∏ó‡∏£‡∏≤‡∏ö</span><br><br><br><br><div class="dot-line"></div></div> <br><br>
                    <p class="text-center w-75">‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏</p> <br><br>
                    <div class="text-center w-75">
                        <div class="dot-line"></div><br><span>‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</span><br><br><br>
                        <div class="dot-line"></div><br><span>‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</span><br><br><br>
                        <div class="dot-line"></div><br><span>‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏≤‡∏ô‡∏∏‡∏Å‡∏≤‡∏£</span>
                    </div>
                </div>
                <div class="col-6">
                    <p class="fw-bold">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß</p>
                    <p><span id="roleLabel" contenteditable="true">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</span> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <span id="totalStaff">0</span> ‡∏Ñ‡∏ô</p>
                    <div class="ps-3">
                        <div class="stat-row"><span>‡∏°‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</span><span><span id="countPresent">0</span> ‡∏Ñ‡∏ô</span></div>
                        <div class="stat-row"><span>‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</span><span><span id="countAbsent">0</span> ‡∏Ñ‡∏ô</span></div>
                        <div class="stat-row"><span>‡∏°‡∏≤‡∏™‡∏≤‡∏¢</span><span><span id="countLate">0</span> ‡∏Ñ‡∏ô</span></div>
                        <div class="stat-row fw-bold mt-2"><span>‡∏£‡∏ß‡∏°‡∏°‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</span><span><span id="countTotalPresent">0</span> ‡∏Ñ‡∏ô</span></div>
                    </div>
                    <br><br><br>
                    <div class="text-center">
                        ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ <div class="dot-line"></div> ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö<br><br>
                        (<span contenteditable="true">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏à‡∏∏‡∏£‡∏µ‡∏†‡∏£‡∏ì‡πå ‡∏Å‡∏∏‡∏î‡∏™‡∏£‡∏∞</span>)<br>
                        <span contenteditable="true">‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = ""; 
        document.getElementById('selectDate').valueAsDate = new Date();

        // Mapping ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ï‡∏≤‡∏° Role (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
        const ROLE_TITLES = {
            "‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£": "‡∏á‡∏≤‡∏ô‡∏à‡πâ‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°",
            "‡∏ä‡πà‡∏≤‡∏á": "‡∏á‡∏≤‡∏ô‡∏à‡πâ‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°",
            "‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô": "‡∏á‡∏≤‡∏ô‡∏à‡πâ‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î",
            "‡∏£‡∏õ‡∏†.": "‡∏á‡∏≤‡∏ô‡∏à‡πâ‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢",
            "default": "‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
        };

        async function loadRoles() {
            try { 
                const res = await axios.get(`${API_URL}/api/roles`);
                res.data.forEach(r => document.getElementById('selectRole').innerHTML += `<option value="${r}">${r}</option>`); 
            } catch(e){}
        }

        async function loadReport() {
            const date = document.getElementById('selectDate').value;
            const role = document.getElementById('selectRole').value;
            const roleTxt = document.getElementById('selectRole').options[document.getElementById('selectRole').selectedIndex].text;
            const lateTime = document.getElementById('lateTime').value + ":00";
            if(!date) return;

            // 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            let title = ROLE_TITLES["default"];
            if (role !== 'all') {
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Role (Partial Match) ‡πÄ‡∏ä‡πà‡∏ô "‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏®‡∏≤‡∏•" ‡∏Å‡πá‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç "‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô"
                for (const key in ROLE_TITLES) {
                    if (roleTxt.includes(key)) {
                        title = ROLE_TITLES[key];
                        break;
                    }
                }
            } else {
                title = "‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
            }
            document.getElementById('reportTitle').innerText = title;
            document.getElementById('roleLabel').innerText = role === 'all' ? "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" : roleTxt;
            
            // 2. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ó‡∏¢
            const thaiDate = new Date(date).toLocaleDateString('th-TH', {day:'numeric', month:'long', year:'numeric'});
            document.getElementById('dateHeader').innerText = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${thaiDate}`;

            try {
                const res = await axios.get(`${API_URL}/api/report/daily?date=${date}&role=${role}`);
                const tbody = document.getElementById('reportTableBody'); tbody.innerHTML = "";
                let [total, present, absent, late] = [res.data.length, 0, 0, 0];
                
                if(total===0) tbody.innerHTML = `<tr><td colspan="7" class="text-center p-3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;

                res.data.forEach((item, i) => {
                    let isPresent = item.time_in !== "-";
                    if(isPresent) { present++; if(item.time_in > lateTime) late++; } else absent++;
                    
                    let remark = item.remark || "";
                    if(isPresent && item.time_in > lateTime && !remark) remark = "‡∏™‡∏≤‡∏¢";

                    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Dep) ‡πÉ‡∏ï‡πâ‡∏ä‡∏∑‡πà‡∏≠
                    const depDisplay = item.department ? `<span class="small-dep">(${item.department})</span>` : "";

                    tbody.innerHTML += `<tr>
                        <td class="text-center">${i+1}</td> 
                        <td>
                            ${item.name}
                            ${depDisplay}
                        </td> 
                        <td></td>
                        <td class="text-center">${item.time_in!=="-"?item.time_in.substring(0,5)+" ‡∏ô.":"-"}</td>
                        <td></td> <td class="text-center">${item.time_out!=="-"?item.time_out.substring(0,5)+" ‡∏ô.":"-"}</td>
                        <td class="text-center text-danger">${remark}</td>
                    </tr>`;
                });

                document.getElementById('totalStaff').innerText = total;
                document.getElementById('countPresent').innerText = present;
                document.getElementById('countAbsent').innerText = absent;
                document.getElementById('countLate').innerText = late;
                document.getElementById('countTotalPresent').innerText = present;
            } catch(e){ alert("Error loading report"); console.error(e); }
        }
        
        loadRoles(); 
        setTimeout(loadReport, 500);
    </script>
</body>
</html>