<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Face Scanner - Time Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #2c3e50; color: white; }
        .video-container { position: relative; width: 100%; max-width: 640px; margin: auto; border: 4px solid #34495e; border-radius: 15px; overflow: hidden; background: #000; }
        #videoElement { width: 100%; height: auto; transform: scaleX(-1); /* ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏à‡∏Å */ }
        .status-box { background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px; text-align: center; }
        .scan-line { position: absolute; width: 100%; height: 2px; background: rgba(0, 255, 0, 0.5); box-shadow: 0 0 10px rgba(0, 255, 0, 1); animation: scan 2s infinite linear; top: 0; }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        .clock { font-size: 3rem; font-weight: bold; color: #0dcaf0; }
        .table { color: white; }
        .table-dark { background-color: transparent; }
    </style>
</head>
<body>

    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom border-secondary pb-3">
            <h3 class="fw-bold m-0"><i class="bi bi-camera-video"></i> Web Scanner (Kiosk Mode)</h3>
            <div>
                <span id="serverStatus" class="badge bg-warning text-dark fs-6">‚è≥ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
                <a href="/" class="btn btn-sm btn-outline-light ms-2">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-7 text-center">
                <div class="video-container shadow-lg">
                    <video id="videoElement" autoplay playsinline></video>
                    <div class="scan-line" id="scanLine" style="display: none;"></div>
                </div>
                
                <div class="status-box mt-3">
                    <h3 id="actionStatus" class="m-0 fw-bold text-light">‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...</h3>
                </div>

                <div class="mt-4">
                    <button class="btn btn-warning btn-lg shadow-sm" id="btnShowManual" onclick="toggleManualBox()">
                        <i class="bi bi-keyboard"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™)
                    </button>

                    <div id="manualBox" class="mt-3 p-3 bg-secondary bg-opacity-50 rounded-3 shadow" style="display: none; max-width: 350px; margin: 0 auto;">
                        <label class="form-label text-light fw-bold fs-5">‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                        <div class="input-group mb-2">
                            <input type="text" id="manualId" class="form-control form-control-lg text-center fw-bold" placeholder="‡∏£‡∏´‡∏±‡∏™...">
                            <button class="btn btn-success px-4" onclick="sendManual()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                        <button class="btn btn-sm btn-outline-light w-100" onclick="toggleManualBox()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="status-box mb-4">
                    <div class="clock" id="clockText">00:00:00</div>
                    <div class="text-secondary" id="dateText">‡∏ß‡∏±‡∏ô ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏õ‡∏µ</div>
                </div>

                <div class="card bg-dark border-secondary">
                    <div class="card-header border-secondary fw-bold">
                        <i class="bi bi-clock-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-dark table-striped m-0">
                            <thead>
                                <tr><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th></tr>
                            </thead>
                            <tbody id="logTable">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="canvas" style="display: none;"></canvas>

    <script>
        const API_URL = ""; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà IP
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvas');
        const actionStatus = document.getElementById('actionStatus');
        
        let isProcessing = false;
        let lastGreetedName = null;
        let lastScanTime = 0;

        // 1. ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤
        setInterval(() => {
            const now = new Date();
            document.getElementById('clockText').innerText = now.toLocaleTimeString('th-TH');
            document.getElementById('dateText').innerText = now.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        }, 1000);

        // 2. ‡πÄ‡∏ä‡πá‡∏Ñ Server Health
        setInterval(async () => {
            try {
                await axios.get(`${API_URL}/health`);
                document.getElementById('serverStatus').className = "badge bg-success fs-6";
                document.getElementById('serverStatus').innerText = "üü¢ Server Online";
            } catch (e) {
                document.getElementById('serverStatus').className = "badge bg-danger fs-6";
                document.getElementById('serverStatus').innerText = "üî¥ Server Offline";
            }
        }, 5000);

        // 3. ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user", width: 640 } });
                video.srcObject = stream;
                actionStatus.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏π‡∏õ‡∏™‡πÅ‡∏Å‡∏ô (‡∏ó‡∏∏‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
                setInterval(captureAndSend, 3000);
            } catch (err) {
                console.error(err);
                actionStatus.innerHTML = "<span class='text-danger'>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ<br><small>(‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô HTTPS)</small></span>";
            }
        }

        // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏π‡∏î‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢ (Web Speech API)
        function speakThai(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'th-TH';
            utterance.rate = 1.0;
            window.speechSynthesis.speak(utterance);
        }

        // 5. ‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ Server
        async function captureAndSend() {
            if (isProcessing) return;
            
            // ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠‡∏•‡∏á Canvas
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            if (canvas.width === 0) return; // ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°

            // ‡∏û‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤ CSS mirror ‡πÑ‡∏ß‡πâ)
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            isProcessing = true;
            document.getElementById('scanLine').style.display = 'block';

            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û (Blob)
            canvas.toBlob(async (blob) => {
                const fd = new FormData();
                fd.append('file', blob, 'webcam.jpg');

                try {
                    const res = await axios.post(`${API_URL}/scan`, fd);
                    handleScanResult(res.data);
                } catch (e) {
                    console.error("Scan Error:", e);
                } finally {
                    isProcessing = false;
                    document.getElementById('scanLine').style.display = 'none';
                }
            }, 'image/jpeg', 0.8);
        }

        // 6. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        function handleScanResult(data) {
            if (data.status === 'OK') {
                const name = data.name;
                
                // ‡∏ñ‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡πÉ‡∏ô 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏û‡∏π‡∏î‡∏ã‡πâ‡∏≥
                if (name !== lastGreetedName || (Date.now() - lastScanTime > 5000)) {
                    speakThai(`‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ${name}`);
                    lastGreetedName = name;
                    
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                    const tbody = document.getElementById('logTable');
                    const timeStr = new Date().toLocaleTimeString('th-TH');
                    tbody.insertAdjacentHTML('afterbegin', `<tr><td class="text-success fw-bold">${name}</td><td>${timeStr}</td></tr>`);
                    if(tbody.children.length > 5) tbody.lastElementChild.remove(); // ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà 5 ‡∏Ñ‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                }
                
                lastScanTime = Date.now();
                actionStatus.innerHTML = `<span class="text-success fw-bold">‚úÖ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö: ${name}</span>`;
                setTimeout(() => actionStatus.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á...", 3000);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™
        function toggleManualBox() {
            const box = document.getElementById('manualBox');
            const btn = document.getElementById('btnShowManual');
            if (box.style.display === 'none') {
                box.style.display = 'block';
                btn.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
                document.getElementById('manualId').focus(); // ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏õ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏£‡∏≠‡πÄ‡∏•‡∏¢
            } else {
                box.style.display = 'none';
                btn.style.display = 'inline-block'; // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
                document.getElementById('manualId').value = '';
            }
        }

        // 7. ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö Manual (‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô)
        async function sendManual() {
            const empId = document.getElementById('manualId').value.trim();
            if(!empId) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™");

            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            context.translate(canvas.width, 0); context.scale(-1, 1);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(async (blob) => {
                const fd = new FormData();
                fd.append('file', blob, 'manual.jpg');
                fd.append('employee_id', empId);

                try {
                    actionStatus.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
                    const res = await axios.post(`${API_URL}/manual_scan`, fd);
                    if(res.data.status === 'OK') {
                        speakThai(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Ñ‡∏∏‡∏ì ${res.data.name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
                        actionStatus.innerHTML = `<span class="text-success fw-bold">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${res.data.name}</span>`;
                        toggleManualBox(); // ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                        document.getElementById('manualId').value = "";
                        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                        const tbody = document.getElementById('logTable');
                        const timeStr = new Date().toLocaleTimeString('th-TH');
                        tbody.insertAdjacentHTML('afterbegin', `<tr><td class="text-success fw-bold">${res.data.name}</td><td>${res.data.time}</td></tr>`);
                        if(tbody.children.length > 5) tbody.lastElementChild.remove(); // ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà 5 ‡∏Ñ‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    } else {
                        alert(res.data.message);
                        actionStatus.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
                    }
                } catch(e) { alert("Error"); }
            }, 'image/jpeg', 0.8);
        }

        // ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
        window.onload = startCamera;
    </script>
</body>
</html>