<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Face Scanner - Time Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #2c3e50; color: white; padding-bottom: 50px; }
        .video-container { position: relative; width: 100%; max-width: 640px; margin: auto; border: 4px solid #34495e; border-radius: 15px; overflow: hidden; background: #000; }
        #videoElement { width: 100%; height: auto; transform: scaleX(-1); object-fit: cover; }
        .status-box { background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px; text-align: center; }
        
        /* ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏•‡πá‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÅ‡∏ü‡∏•‡∏ä */
        .face-guide { position: absolute; top: 15%; left: 20%; right: 20%; bottom: 15%; border: 2px dashed rgba(255,255,255,0.4); border-radius: 20px; pointer-events: none; }
        #flashOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(40, 167, 69, 0.6); opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 10; }
        
        .scan-line { position: absolute; width: 100%; height: 3px; background: rgba(0, 255, 255, 0.7); box-shadow: 0 0 15px rgba(0, 255, 255, 1); animation: scan 2s infinite linear; top: 0; z-index: 5; }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        
        .clock { font-size: 3rem; font-weight: bold; color: #0dcaf0; }
        .table { color: white; }
        .table-dark { background-color: transparent; }
        
        /* ‡πÅ‡∏ñ‡∏ö‡∏ï‡∏±‡∏ß‡∏ß‡∏¥‡πà‡∏á */
        .ticker-wrap { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #1a252f; border-top: 2px solid #f39c12; color: #f1c40f; padding: 8px 0; font-size: 1.2rem; z-index: 1000; }
    </style>
</head>
<body>

    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom border-secondary pb-3">
            <h3 class="fw-bold m-0"><i class="bi bi-camera-video"></i> Web Scanner (Kiosk Mode)</h3>
            <div>
                <span id="serverStatus" class="badge bg-warning text-dark fs-6">‚è≥ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
                <button class="btn btn-sm btn-outline-info ms-2" onclick="toggleFullScreen()">
                    <i class="bi bi-arrows-fullscreen"></i> ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠
                </button>
                <a href="/admin" class="btn btn-sm btn-outline-light ms-2"><i class="bi bi-gear"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</a>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-7 text-center">
                
                <div class="video-container shadow-lg">
                    <video id="videoElement" autoplay playsinline></video>
                    <div class="face-guide"></div> <div id="flashOverlay"></div> <div class="scan-line" id="scanLine" style="display: none;"></div>
                </div>
                
                <div class="status-box mt-3">
                    <h3 id="actionStatus" class="m-0 fw-bold text-light">‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...</h3>
                </div>

                <div class="mt-4">
                    <button class="btn btn-warning btn-lg shadow-sm" id="btnShowManual" onclick="toggleManualBox()">
                        <i class="bi bi-keyboard"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™)
                    </button>

                    <div id="manualBox" class="mt-3 p-3 bg-secondary bg-opacity-50 rounded-3 shadow" style="display: none; max-width: 350px; margin: 0 auto;">
                        <label class="form-label text-light fw-bold fs-5">‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                        <div class="d-flex gap-2 mb-2">
                            <input type="text" id="manualId" class="form-control form-control-lg text-center fw-bold" placeholder="‡∏£‡∏´‡∏±‡∏™...">
                            <button class="btn btn-success px-4" onclick="sendManual()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                        <button class="btn btn-sm btn-outline-light w-100" onclick="toggleManualBox()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="status-box mb-4">
                    <div class="clock" id="clockText">00:00:00</div>
                    <div class="text-secondary" id="dateText">‡∏ß‡∏±‡∏ô ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏õ‡∏µ</div>
                </div>

                <div class="card bg-dark border-secondary">
                    <div class="card-header border-secondary fw-bold">
                        <i class="bi bi-clock-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-dark table-striped m-0">
                            <thead>
                                <tr><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th></tr>
                            </thead>
                            <tbody id="logTable">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="ticker-wrap shadow-lg">
        <marquee behavior="scroll" direction="left" id="cryptoTicker" scrollamount="6">
            ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏•‡∏≤‡∏î...
        </marquee>
    </div>

    <canvas id="canvas" style="display: none;"></canvas>

    <script>
        const API_URL = ""; 
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvas');
        const actionStatus = document.getElementById('actionStatus');
        
        let isProcessing = false;
        let lastGreetedName = null;
        let lastScanTime = 0;
        let scanIntervalId = null;

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Web Audio API) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå)
        document.body.addEventListener('click', () => { if(audioCtx.state === 'suspended') audioCtx.resume(); }, { once: true });

        function playSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            if (type === 'scan') {
                // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏¥‡πä‡∏î‡∏™‡∏±‡πâ‡∏ô‡πÜ (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô)
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'success') {
                // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏¥‡πä‡∏á‡∏ï‡πà‡∏≠‡∏á (‡∏ú‡πà‡∏≤‡∏ô)
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(523.25, audioCtx.currentTime); // ‡πÇ‡∏î
                osc.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.15); // ‡∏°‡∏µ
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                osc.start(); osc.stop(audioCtx.currentTime + 0.5);
            }
        }

        // --- Auto-Reload ‡∏Å‡∏±‡∏ô Memory Leak (‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏∏‡∏Å 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á) ---
        setTimeout(() => { window.location.reload(); }, 60 * 60 * 1000);

        // --- 1. ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ ---
        setInterval(() => {
            const now = new Date();
            document.getElementById('clockText').innerText = now.toLocaleTimeString('th-TH');
            document.getElementById('dateText').innerText = now.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        }, 1000);

        // --- 2. ‡πÄ‡∏ä‡πá‡∏Ñ Server Health ---
        setInterval(async () => {
            try {
                await axios.get(`${API_URL}/health`);
                document.getElementById('serverStatus').className = "badge bg-success fs-6";
                document.getElementById('serverStatus').innerText = "üü¢ Server Online";
            } catch (e) {
                document.getElementById('serverStatus').className = "badge bg-danger fs-6";
                document.getElementById('serverStatus').innerText = "üî¥ Server Offline";
            }
        }, 5000);

        // --- 3. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ Crypto (‡∏ï‡∏±‡∏ß‡∏ß‡∏¥‡πà‡∏á) ---
        async function updateTicker() {
            try {
                const resBtc = await axios.get('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
                const resEth = await axios.get('https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT');
                const btc = parseFloat(resBtc.data.price).toLocaleString('en-US', {minimumFractionDigits: 2});
                const eth = parseFloat(resEth.data.price).toLocaleString('en-US', {minimumFractionDigits: 2});
                
                document.getElementById('cryptoTicker').innerHTML = 
                    `üìà <b>Crypto Market (Real-time):</b> &nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#00ff00;">‚Çø <b>BTC:</b> $${btc}</span> &nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#00ffff;">üíé <b>ETH:</b> $${eth}</span> &nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp; ‚è∞ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleTimeString('th-TH')}`;
            } catch (e) { console.log("Ticker Error"); }
        }
        setInterval(updateTicker, 10000); updateTicker();

        // --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ (Fullscreen) ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(err => {});
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        // --- 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Error ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î) ---
        async function startCamera() {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ú‡πà‡∏≤‡∏ô HTTPS/localhost ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                actionStatus.innerHTML = "<span class='text-danger'>‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á<br><small>(‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ú‡πà‡∏≤‡∏ô <b>https://</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>localhost</b> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</small></span>";
                return;
            }

            const constraints = {
                video: { facingMode: "user", width: { ideal: 640 } }
            };
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                actionStatus.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
                
                if(!scanIntervalId) scanIntervalId = setInterval(captureAndSend, 3000);
            } catch (err) {
                console.error(err);
                
                // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Error ‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡πâ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    actionStatus.innerHTML = "<span class='text-danger'>‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á<br><small>(‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏£‡∏π‡∏õ üîí ‡∏ö‡∏ô‡πÅ‡∏ñ‡∏ö URL ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏•‡πâ‡∏≠‡∏á</b>)</small></span>";
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    actionStatus.innerHTML = "<span class='text-danger'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ<br><small>(‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á)</small></span>";
                } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                    actionStatus.innerHTML = "<span class='text-danger'>‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà<br><small>(‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö)</small></span>";
                } else {
                    actionStatus.innerHTML = `<span class='text-danger'>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ${err.name}<br><small>(‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô HTTPS)</small></span>`;
                }
            }
        }

        // --- 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏π‡∏î‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢ & ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÅ‡∏ü‡∏•‡∏ä ---
        function speakThai(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'th-TH'; utterance.rate = 1.0;
            window.speechSynthesis.speak(utterance);
        }

        function triggerFlash() {
            const flash = document.getElementById('flashOverlay');
            flash.style.opacity = '1';
            setTimeout(() => flash.style.opacity = '0', 300);
        }

        function toggleManualBox() {
            const box = document.getElementById('manualBox');
            const btn = document.getElementById('btnShowManual');
            if (box.style.display === 'none') {
                box.style.display = 'block'; btn.style.display = 'none';
                document.getElementById('manualId').focus();
            } else {
                box.style.display = 'none'; btn.style.display = 'inline-block';
                document.getElementById('manualId').value = '';
            }
        }

        // --- 7. ‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ Server ---
        async function captureAndSend() {
            if (isProcessing) return;
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            if (canvas.width === 0) return;

            context.translate(canvas.width, 0); context.scale(-1, 1);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            isProcessing = true;
            document.getElementById('scanLine').style.display = 'block';
            // playSound('scan'); // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏¥‡πä‡∏î‡∏™‡∏±‡πâ‡∏ô‡πÜ‡∏ï‡∏≠‡∏ô‡∏¢‡∏¥‡∏á API

            canvas.toBlob(async (blob) => {
                const fd = new FormData();
                fd.append('file', blob, 'webcam.jpg');

                try {
                    const res = await axios.post(`${API_URL}/scan`, fd);
                    handleScanResult(res.data);
                } catch (e) { console.error("Scan Error:", e); } 
                finally {
                    isProcessing = false;
                    document.getElementById('scanLine').style.display = 'none';
                }
            }, 'image/jpeg', 0.8);
        }

        // --- 8. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ---
        function handleScanResult(data) {
            if (data.status === 'OK') {
                const name = data.name;
                if (name !== lastGreetedName || (Date.now() - lastScanTime > 5000)) {
                    triggerFlash();       // ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ß‡∏≤‡∏ö‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                    playSound('success'); // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏¥‡πä‡∏á‡∏ï‡πà‡∏≠‡∏á
                    speakThai(`‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${name}`); // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î
                    lastGreetedName = name;
                    
                    const tbody = document.getElementById('logTable');
                    const timeStr = data.time || new Date().toLocaleTimeString('th-TH');
                    tbody.insertAdjacentHTML('afterbegin', `<tr><td class="text-success fw-bold">${name}</td><td>${timeStr}</td></tr>`);
                    if(tbody.children.length > 5) tbody.lastElementChild.remove();
                }
                
                lastScanTime = Date.now();
                actionStatus.innerHTML = `<span class="text-success fw-bold">‚úÖ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö: ${name}</span>`;
                setTimeout(() => actionStatus.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á...", 3000);
            }
        }

        // --- 9. ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö Manual (‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô) ---
        async function sendManual() {
            const empId = document.getElementById('manualId').value.trim();
            if(!empId) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™");

            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            context.translate(canvas.width, 0); context.scale(-1, 1);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(async (blob) => {
                const fd = new FormData();
                fd.append('file', blob, 'manual.jpg');
                fd.append('employee_id', empId);

                try {
                    actionStatus.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
                    const res = await axios.post(`${API_URL}/manual_scan`, fd);
                    if(res.data.status === 'OK') {
                        triggerFlash();
                        playSound('success');
                        speakThai(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${res.data.name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
                        actionStatus.innerHTML = `<span class="text-success fw-bold">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${res.data.name}</span>`;
                        
                        const tbody = document.getElementById('logTable');
                        const timeStr = res.data.time || new Date().toLocaleTimeString('th-TH');
                        tbody.insertAdjacentHTML('afterbegin', `<tr><td class="text-success fw-bold">${res.data.name}</td><td>${timeStr}</td></tr>`);
                        if(tbody.children.length > 5) tbody.lastElementChild.remove();
                        
                        toggleManualBox();
                    } else {
                        alert(res.data.message);
                        actionStatus.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
                    }
                } catch(e) { alert("Error"); }
            }, 'image/jpeg', 0.8);
        }

        window.onload = startCamera;
    </script>
</body>
</html>