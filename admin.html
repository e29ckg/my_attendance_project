<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô - Time Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Sarabun', sans-serif; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .table-img { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
        .search-box input { padding-left: 40px; }
        .list-group-item { display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="/"><i class="bi bi-person-bounding-box"></i> HR Face Scan</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></li>
                    <li class="nav-item"><a class="nav-link active fw-bold" href="/admin">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</a></li>
                    <li class="nav-item"><a class="nav-link" href="/report">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</a></li>
                    <li class="nav-item"><a class="nav-link" href="/print">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold text-secondary"><i class="bi bi-people-fill"></i> ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h4>
            <div>
                <button class="btn btn-secondary me-2 shadow-sm" onclick="openRoleModal()">
                    <i class="bi bi-gear-fill"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                </button>
                <button class="btn btn-primary shadow-sm" onclick="openAddModal()">
                    <i class="bi bi-person-plus-fill"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>

        <div class="card p-3 mb-4">
            <div class="row g-3">
                <div class="col-md-6 position-relative search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" id="searchInput" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô..." onkeyup="filterData()">
                </div>
                <div class="col-md-4">
                    <select id="roleFilter" class="form-select" onchange="filterData()">
                        <option value="all">‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
                    </select>
                </div>
                <div class="col-md-2 text-end align-self-center">
                    <span class="text-muted small">‡∏û‡∏ö <b id="count">0</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                </div>
            </div>
        </div>

        <div class="card p-4">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th width="80">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                            <th>‡∏£‡∏´‡∏±‡∏™</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                            <th width="150" class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="employeeTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="employeeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="modalTitle">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="empForm">
                        <input type="hidden" id="mode" value="add">
                        <div class="mb-3">
                            <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                            <input type="text" class="form-control" id="empId" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" class="form-control" id="empName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                            <select class="form-select" id="empRole" required>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á --</option>
                            </select>
                            <div class="form-text text-end"><a href="#" onclick="myModal.hide(); openRoleModal();" style="text-decoration:none; font-size: 12px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà</a></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢</label>
                            <input type="file" class="form-control" id="empPhoto" accept="image/*">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary" onclick="saveData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="roleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡πÅ‡∏ú‡∏ô‡∏Å</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" id="newRoleInput" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà...">
                        <button class="btn btn-success" type="button" onclick="addNewRole()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                    <ul class="list-group" id="roleList">
                        </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = ""; 
        let allEmployees = [];
        let allRoles = [];

        // --- ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
        async function loadEmployees() {
            try {
                // ‡πÇ‡∏´‡∏•‡∏î Roles ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà‡πÉ‡∏ô Dropdown
                await loadRoles();
                
                const res = await axios.get(`${API_BASE}/api/employees`);
                allEmployees = res.data;
                renderTable(allEmployees);
            } catch (error) { console.error(error); }
        }

        async function loadRoles() {
            try {
                const res = await axios.get(`${API_BASE}/api/roles`);
                allRoles = res.data;
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Filter Dropdown
                const filterSel = document.getElementById('roleFilter');
                const currentFilter = filterSel.value;
                filterSel.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>';
                allRoles.forEach(r => filterSel.innerHTML += `<option value="${r}">${r}</option>`);
                filterSel.value = currentFilter;

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Modal Dropdown
                const modalSel = document.getElementById('empRole');
                modalSel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á --</option>';
                allRoles.forEach(r => modalSel.innerHTML += `<option value="${r}">${r}</option>`);

            } catch (error) { console.error(error); }
        }

        // --- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ---
        function renderTable(data) {
            const tbody = document.getElementById('employeeTable');
            document.getElementById('count').innerText = data.length;
            tbody.innerHTML = "";
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return;
            }
            data.forEach(emp => {
                const imgUrl = emp.image_path ? `${API_BASE}/${emp.image_path}?t=${Date.now()}` : "https://via.placeholder.com/50";
                const safeName = emp.name.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                tbody.innerHTML += `
                <tr>
                    <td><img src="${imgUrl}" class="table-img"></td>
                    <td class="fw-bold text-secondary">${emp.employee_id}</td>
                    <td>${emp.name}</td>
                    <td><span class="badge bg-light text-dark border">${emp.role}</span></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-warning me-1" onclick="openEditModal('${emp.employee_id}', '${safeName}', '${emp.role}')"><i class="bi bi-pencil-fill"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteEmp('${emp.employee_id}')"><i class="bi bi-trash-fill"></i></button>
                    </td>
                </tr>`;
            });
        }

        function filterData() {
            const txt = document.getElementById('searchInput').value.toLowerCase();
            const role = document.getElementById('roleFilter').value;
            renderTable(allEmployees.filter(e => 
                (e.name.toLowerCase().includes(txt) || e.employee_id.toLowerCase().includes(txt)) &&
                (role === "all" || e.role === role)
            ));
        }

        // --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Add/Edit) ---
        const myModal = new bootstrap.Modal(document.getElementById('employeeModal'));
        function openAddModal() {
            document.getElementById('modalTitle').innerText = "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà";
            document.getElementById('mode').value = "add";
            document.getElementById('empForm').reset();
            document.getElementById('empId').disabled = false;
            myModal.show();
        }
        function openEditModal(id, name, role) {
            document.getElementById('modalTitle').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            document.getElementById('mode').value = "edit";
            document.getElementById('empId').value = id;
            document.getElementById('empName').value = name;
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÑ‡∏´‡∏° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡∏Å‡∏±‡∏ô‡∏ö‡∏±‡∏Ñ)
            const sel = document.getElementById('empRole');
            if (![...sel.options].some(o => o.value === role)) {
                const opt = document.createElement('option'); opt.value = role; opt.innerText = role; sel.add(opt);
            }
            sel.value = role;
            
            document.getElementById('empPhoto').value = "";
            document.getElementById('empId').disabled = true;
            myModal.show();
        }

        async function saveData() {
            const mode = document.getElementById('mode').value;
            const id = document.getElementById('empId').value;
            const name = document.getElementById('empName').value;
            const role = document.getElementById('empRole').value;
            const file = document.getElementById('empPhoto').files[0];
            
            if (!id || !name || !role) { Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning'); return; }
            
            const formData = new FormData();
            formData.append('emp_id', id); formData.append('name', name); formData.append('role', role);
            if (file) formData.append('file', file);
            
            const url = mode === "add" ? "/api/register" : "/api/employees/update";
            try {
                Swal.fire({title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading()});
                await axios.post(`${API_BASE}${url}`, formData);
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                myModal.hide(); loadEmployees();
            } catch (e) { Swal.fire('Error', e.message, 'error'); }
        }

        async function deleteEmp(id) {
            if((await Swal.fire({title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?', showCancelButton:true})).isConfirmed){
                await axios.delete(`${API_BASE}/api/employees/delete/${id}`);
                loadEmployees();
            }
        }

        // --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Role (New Feature) ---
        const roleModal = new bootstrap.Modal(document.getElementById('roleModal'));
        function openRoleModal() {
            renderRoleList();
            roleModal.show();
        }

        function renderRoleList() {
            const list = document.getElementById('roleList');
            list.innerHTML = "";
            allRoles.forEach(r => {
                list.innerHTML += `
                <li class="list-group-item">
                    ${r}
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteRole('${r}')"><i class="bi bi-trash"></i></button>
                </li>`;
            });
        }

        async function addNewRole() {
            const newRole = document.getElementById('newRoleInput').value.trim();
            if(!newRole) return;
            try {
                const fd = new FormData(); fd.append('role_name', newRole);
                await axios.post(`${API_BASE}/api/roles`, fd);
                document.getElementById('newRoleInput').value = "";
                await loadRoles(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
                renderRoleList(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÉ‡∏ô Modal
            } catch(e) { alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
        }

        async function deleteRole(roleName) {
            if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á "${roleName}" ?`)) return;
            try {
                await axios.delete(`${API_BASE}/api/roles/${roleName}`);
                await loadRoles();
                renderRoleList();
            } catch(e) { alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
        }

        // Start
        loadEmployees();
    </script>
</body>
</html>